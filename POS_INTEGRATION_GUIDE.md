# üîå POS System Integration Guide

This guide shows how to integrate the POS system with your React frontend.

## üìã Table of Contents

1. [Installation](#installation)
2. [Supabase Setup](#supabase-setup)
3. [Frontend Integration](#frontend-integration)
4. [Example Components](#example-components)
5. [API Examples](#api-examples)

---

## üöÄ Installation

### Step 1: Run Database Migrations

In your Supabase dashboard SQL Editor, run these files in order:

```sql
-- 1. First run the core POS system
-- Copy and paste from: supabase/migrations/20250102000000_create_pos_system.sql

-- 2. Then run advanced features  
-- Copy and paste from: supabase/migrations/20250102000001_pos_advanced_features.sql
```

Or using Supabase CLI:

```bash
supabase migration up
```

### Step 2: Verify Installation

```sql
-- Check if tables exist
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
AND table_name IN ('customers', 'orders', 'inventory', 'staff');

-- Should return 4 rows
```

---

## ‚öôÔ∏è Supabase Setup

### 1. Create Helper Functions in Your Project

Create a new file: `src/lib/pos.ts`

```typescript
import { supabase } from './supabase';

// Type Definitions
export interface Customer {
  id: string;
  customer_code: string;
  name: string;
  email?: string;
  phone: string;
  address?: string;
  pet_name?: string;
  pet_type?: string;
  pet_breed?: string;
  total_orders: number;
  total_spent: number;
  loyalty_points: number;
}

export interface Order {
  id: string;
  order_number: string;
  customer_id?: string;
  staff_id?: string;
  order_type: 'in-store' | 'online' | 'delivery';
  subtotal: number;
  discount_amount: number;
  total_amount: number;
  payment_status: 'pending' | 'paid' | 'partial' | 'refunded';
  order_status: 'pending' | 'processing' | 'completed' | 'cancelled';
  order_date: string;
}

export interface OrderItem {
  id: string;
  order_id: string;
  menu_item_id: string;
  item_name: string;
  unit_price: number;
  quantity: number;
  total_price: number;
}

export interface InventoryItem {
  id: string;
  menu_item_id: string;
  current_stock: number;
  minimum_stock: number;
  is_low_stock: boolean;
  is_out_of_stock: boolean;
}

// POS API Functions
export const posAPI = {
  // ==================== CUSTOMERS ====================
  
  async createCustomer(data: {
    name: string;
    phone: string;
    email?: string;
    address?: string;
    pet_name?: string;
    pet_type?: string;
    pet_breed?: string;
  }) {
    const { data: customer, error } = await supabase
      .from('customers')
      .insert([{
        customer_code: '', // Will be auto-generated by trigger
        ...data
      }])
      .select()
      .single();
    
    if (error) throw error;
    return customer;
  },

  async findCustomerByPhone(phone: string) {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .ilike('phone', `%${phone}%`)
      .eq('is_active', true)
      .limit(10);
    
    if (error) throw error;
    return data;
  },

  async getCustomerById(id: string) {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data;
  },

  // ==================== ORDERS ====================
  
  async createOrder(orderData: {
    customer_id?: string;
    staff_id?: string;
    order_type: string;
    customer_name?: string;
    customer_phone?: string;
    items: {
      menu_item_id: string;
      item_name: string;
      unit_price: number;
      quantity: number;
    }[];
    discount_amount?: number;
  }) {
    // Calculate totals
    const subtotal = orderData.items.reduce(
      (sum, item) => sum + (item.unit_price * item.quantity), 
      0
    );
    const discount = orderData.discount_amount || 0;
    const total = subtotal - discount;

    // Create order
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .insert([{
        order_number: '', // Will be auto-generated
        customer_id: orderData.customer_id,
        staff_id: orderData.staff_id,
        order_type: orderData.order_type,
        customer_name: orderData.customer_name,
        customer_phone: orderData.customer_phone,
        subtotal,
        discount_amount: discount,
        total_amount: total,
        payment_status: 'pending',
        order_status: 'pending'
      }])
      .select()
      .single();

    if (orderError) throw orderError;

    // Create order items
    const orderItems = orderData.items.map(item => ({
      order_id: order.id,
      menu_item_id: item.menu_item_id,
      item_name: item.item_name,
      unit_price: item.unit_price,
      quantity: item.quantity,
      total_price: item.unit_price * item.quantity
    }));

    const { error: itemsError } = await supabase
      .from('order_items')
      .insert(orderItems);

    if (itemsError) throw itemsError;

    return order;
  },

  async completeOrder(orderId: string) {
    const { data, error } = await supabase
      .from('orders')
      .update({
        payment_status: 'paid',
        order_status: 'completed',
        paid_at: new Date().toISOString(),
        completed_at: new Date().toISOString()
      })
      .eq('id', orderId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  async getOrderById(orderId: string) {
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select(`
        *,
        order_items (
          *
        ),
        customers (
          name,
          phone,
          pet_name,
          loyalty_points
        )
      `)
      .eq('id', orderId)
      .single();

    if (orderError) throw orderError;
    return order;
  },

  // ==================== PAYMENTS ====================
  
  async createPayment(data: {
    order_id: string;
    payment_method: string;
    amount: number;
    reference_number?: string;
  }) {
    const { data: payment, error } = await supabase
      .from('payments')
      .insert([{
        payment_number: '', // Auto-generated
        ...data,
        payment_status: 'completed'
      }])
      .select()
      .single();

    if (error) throw error;
    return payment;
  },

  // ==================== INVENTORY ====================
  
  async getInventory() {
    const { data, error } = await supabase
      .from('inventory')
      .select(`
        *,
        menu_items (
          id,
          name,
          base_price,
          category
        )
      `)
      .eq('is_tracked', true)
      .order('current_stock', { ascending: true });

    if (error) throw error;
    return data;
  },

  async getLowStockItems() {
    const { data, error } = await supabase
      .from('low_stock_items')
      .select('*');

    if (error) throw error;
    return data;
  },

  async checkStock(menuItemId: string) {
    const { data, error } = await supabase
      .from('inventory')
      .select('current_stock, is_out_of_stock')
      .eq('menu_item_id', menuItemId)
      .single();

    if (error) throw error;
    return data;
  },

  // ==================== ANALYTICS ====================
  
  async getDailySales(date: string) {
    const { data, error } = await supabase
      .rpc('get_sales_by_date_range', {
        start_date: date,
        end_date: date
      });

    if (error) throw error;
    return data;
  },

  async getTopProducts(daysBack: number = 30) {
    const { data, error } = await supabase
      .rpc('get_product_performance', {
        days_back: daysBack
      });

    if (error) throw error;
    return data;
  },

  async getCustomerAnalytics() {
    const { data, error } = await supabase
      .rpc('get_customer_analytics');

    if (error) throw error;
    return data;
  }
};
```

---

## üé® Frontend Integration

### 1. Update Your Existing Checkout

In `src/components/Checkout.tsx`, add POS integration:

```typescript
import { posAPI } from '../lib/pos';

// When order is submitted
const handlePlaceOrder = async () => {
  try {
    // 1. Create the order in POS system
    const order = await posAPI.createOrder({
      customer_name: customerName,
      customer_phone: contactNumber,
      order_type: serviceType,
      items: cartItems.map(item => ({
        menu_item_id: item.id,
        item_name: item.name,
        unit_price: item.totalPrice,
        quantity: item.quantity
      })),
      discount_amount: 0 // Add if you have discounts
    });

    // 2. Process payment
    await posAPI.createPayment({
      order_id: order.id,
      payment_method: paymentMethod,
      amount: totalPrice,
      reference_number: referenceNumber
    });

    // 3. Complete the order
    await posAPI.completeOrder(order.id);

    // 4. Show success message
    alert(`Order ${order.order_number} created successfully!`);
    
  } catch (error) {
    console.error('Error creating order:', error);
    alert('Failed to create order. Please try again.');
  }
};
```

### 2. Add Customer Lookup

```typescript
const CustomerLookup = () => {
  const [phone, setPhone] = useState('');
  const [customers, setCustomers] = useState([]);

  const handleSearch = async () => {
    const results = await posAPI.findCustomerByPhone(phone);
    setCustomers(results);
  };

  return (
    <div>
      <input
        type="tel"
        value={phone}
        onChange={(e) => setPhone(e.target.value)}
        placeholder="Search by phone..."
      />
      <button onClick={handleSearch}>Search</button>
      
      {customers.map(customer => (
        <div key={customer.id}>
          <p>{customer.name} - {customer.phone}</p>
          <p>Pet: {customer.pet_name} ({customer.pet_type})</p>
          <p>Points: {customer.loyalty_points}</p>
        </div>
      ))}
    </div>
  );
};
```

### 3. Add Inventory Checker

```typescript
const InventoryStatus = ({ menuItemId }: { menuItemId: string }) => {
  const [stock, setStock] = useState(null);

  useEffect(() => {
    const checkInventory = async () => {
      const data = await posAPI.checkStock(menuItemId);
      setStock(data);
    };
    checkInventory();
  }, [menuItemId]);

  if (!stock) return null;

  return (
    <div>
      {stock.is_out_of_stock ? (
        <span className="text-red-600">Out of Stock</span>
      ) : (
        <span className="text-green-600">
          In Stock: {stock.current_stock}
        </span>
      )}
    </div>
  );
};
```

---

## üìä Example: Sales Dashboard Component

Create `src/components/SalesDashboard.tsx`:

```typescript
import React, { useEffect, useState } from 'react';
import { posAPI } from '../lib/pos';

const SalesDashboard = () => {
  const [todaySales, setTodaySales] = useState(null);
  const [topProducts, setTopProducts] = useState([]);
  const [lowStock, setLowStock] = useState([]);

  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    try {
      // Get today's sales
      const today = new Date().toISOString().split('T')[0];
      const sales = await posAPI.getDailySales(today);
      setTodaySales(sales[0]);

      // Get top products
      const products = await posAPI.getTopProducts(30);
      setTopProducts(products.slice(0, 5));

      // Get low stock items
      const stock = await posAPI.getLowStockItems();
      setLowStock(stock);
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">Sales Dashboard</h1>

      {/* Today's Sales */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-gray-500 text-sm">Total Sales</h3>
          <p className="text-3xl font-bold text-pet-orange">
            ‚Ç±{todaySales?.total_sales?.toFixed(2) || '0.00'}
          </p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-gray-500 text-sm">Orders</h3>
          <p className="text-3xl font-bold">{todaySales?.total_orders || 0}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-gray-500 text-sm">Avg Order Value</h3>
          <p className="text-3xl font-bold">
            ‚Ç±{todaySales?.average_order_value?.toFixed(2) || '0.00'}
          </p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-gray-500 text-sm">Customers</h3>
          <p className="text-3xl font-bold">{todaySales?.total_customers || 0}</p>
        </div>
      </div>

      {/* Top Products */}
      <div className="bg-white p-6 rounded-lg shadow mb-8">
        <h2 className="text-xl font-bold mb-4">Top Selling Products</h2>
        <table className="w-full">
          <thead>
            <tr className="border-b">
              <th className="text-left p-2">Product</th>
              <th className="text-right p-2">Sold</th>
              <th className="text-right p-2">Revenue</th>
            </tr>
          </thead>
          <tbody>
            {topProducts.map((product, index) => (
              <tr key={index} className="border-b">
                <td className="p-2">{product.product_name}</td>
                <td className="text-right p-2">{product.total_quantity}</td>
                <td className="text-right p-2">‚Ç±{product.total_revenue?.toFixed(2)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Low Stock Alert */}
      {lowStock.length > 0 && (
        <div className="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
          <h2 className="text-xl font-bold text-red-700 mb-4">
            ‚ö†Ô∏è Low Stock Alert
          </h2>
          <ul>
            {lowStock.map((item, index) => (
              <li key={index} className="mb-2">
                <span className="font-semibold">{item.name}</span>
                <span className="text-red-600 ml-2">
                  (Stock: {item.current_stock})
                </span>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

export default SalesDashboard;
```

---

## üîó Add to Admin Dashboard

In `src/components/AdminDashboard.tsx`, add a POS section:

```typescript
import SalesDashboard from './SalesDashboard';

// Add new tab
const tabs = [
  'Products',
  'Categories',
  'Payment Methods',
  'Site Settings',
  'POS Dashboard'  // New tab
];

// In the render
{activeTab === 'POS Dashboard' && <SalesDashboard />}
```

---

## ‚úÖ Testing

### 1. Test Customer Creation

```typescript
const testCustomer = async () => {
  const customer = await posAPI.createCustomer({
    name: 'Test Customer',
    phone: '09123456789',
    email: 'test@email.com',
    pet_name: 'Buddy',
    pet_type: 'dog',
    pet_breed: 'Golden Retriever'
  });
  console.log('Customer created:', customer);
};
```

### 2. Test Order Creation

```typescript
const testOrder = async () => {
  const order = await posAPI.createOrder({
    customer_name: 'Walk-in Customer',
    customer_phone: '09123456789',
    order_type: 'in-store',
    items: [
      {
        menu_item_id: 'your-menu-item-id',
        item_name: 'Dog Food 5kg',
        unit_price: 500,
        quantity: 2
      }
    ]
  });
  console.log('Order created:', order);
};
```

---

## üéØ Next Steps

1. **Customize the integration** to match your exact needs
2. **Add more POS features** like staff management, cash drawer
3. **Create a dedicated POS page** for in-store sales
4. **Add real-time inventory updates** to product pages
5. **Implement customer lookup** in checkout
6. **Add loyalty points display** for customers
7. **Create sales reports** page

---

## üìù Notes

- All database operations are handled server-side by Supabase
- RLS policies are already configured for security
- Functions are optimized for performance
- Error handling should be added to all API calls
- Consider adding loading states in components

---

**Your POS system is now integrated and ready to use!** üéâ

